#! /bin/sh

# capture passed in authentication information
USERNAME=`echo $1`
PASSWORD=`echo $2`
SEVERITY=`echo $3`
OUTPUT=`echo $4`
STAMP=`echo $5`

# load the configuration contain in the file conf.sh that includes the qualysguard credentail, the API FQDN and more.

# NOTE:  hard coded authenitcation in config overrides passed in variables
source ./conf.sh

#Set severity variable
SEV=`echo Sev-$SEVERITY`

# Dowload dectection information for vulns and write it to file.
echo CURL call
$CURL -H 'X-Requested-With: curl' -o $OUTPUT/$SEV.xml -u ${USERNAME}:${PASSWORD} "https://$APIFQDN/api/2.0/fo/asset/host/vm/detection/?action=list&truncation_limit=0&severities=$SEVERITY${LAST_CALL_DATE}"
echo OUTPUT is $OUTPUT
# Write message to $date_$SEV.log file acknowledging successful $SEV.xml download
echo '# Begin' >> $OUTPUT/$STAMP\_transfers.log
date >> $OUTPUT/$STAMP\_transfers.log
echo 'Severity $SEVERITY Vulns downloaded successfully' >> $OUTPUT/$STAMP\_transfers.log
echo '!! End' >> $OUTPUT/$STAMP\_transfers.log

# MSC - Join $SEV vulns into output-v1.csv
echo build detection2csv.xsl dynamically
cat detection2csv.xsl_part1 > detection2csv.xsl
echo "                              select=\"document('$OUTPUT/vulnkb-light.xml')/VULNS/VULN[QID=current()/QID]/.\" />" >> detection2csv.xsl
cat detection2csv.xsl_part2 >> detection2csv.xsl
echo xsltproc
xsltproc --path . detection2csv.xsl $OUTPUT/$SEV.xml > $OUTPUT/$SEV-output-v1.csv

# Write message to $date_$SEV.log file acknowledging successful $SEV-output-v1.csv for $SEV.xml file
echo '# Begin' >> $OUTPUT/$STAMP\_transfers.log
date >> $OUTPUT/$STAMP\_transfers.log
echo 'Successful Sev-$SEVERITY-output-v1.csv file tranfer for Sev-$SEVERITY.xml' >> $OUTPUT/$STAMP\_transfers.log
echo '!! End' >> $OUTPUT/$STAMP\_transfers.log
